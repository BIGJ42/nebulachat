<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Uplink</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0c0c0e;
            --sidebar: #131316;
            --panel: #1c1c21;
            --border: #2d2d35;
            /* SIGNAL GREEN THEME */
            --primary: #10b981; /* Emerald 500 */
            --primary-hover: #059669;
            --primary-dim: rgba(16, 185, 129, 0.1);
            
            --text: #e4e4e7;
            --text-dim: #71717a;
            --danger: #ef4444;
            --success: #10b981;
            --glass: rgba(19, 19, 22, 0.8);
            
            --font-ui: 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; font-family: var(--font-ui); background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* --- ANIMATIONS --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- LAYOUT --- */
        .hidden { display: none !important; }
        
        /* SIDEBAR */
        aside { width: 320px; background: var(--sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 10; }
        
        .brand-section { padding: 25px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 10px; }
        .signal-icon { width: 24px; height: 24px; fill: var(--primary); animation: pulse 2s infinite; }
        .brand-text { font-family: var(--font-mono); font-weight: 700; font-size: 18px; letter-spacing: -0.5px; }

        .profile-strip { padding: 15px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid var(--border); background: var(--panel); cursor: pointer; transition: 0.2s; }
        .profile-strip:hover { background: #27272a; }
        .my-avatar { width: 38px; height: 38px; border-radius: 6px; border: 1px solid var(--border); object-fit: cover; }
        
        /* TABS */
        .nav-tabs { display: flex; padding: 10px 15px; gap: 5px; border-bottom: 1px solid var(--border); }
        .nav-item { flex: 1; padding: 8px; text-align: center; font-size: 12px; font-weight: 600; color: var(--text-dim); cursor: pointer; border-radius: 6px; transition: 0.2s; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-item:hover { color: var(--text); background: var(--panel); }
        .nav-item.active { background: var(--primary-dim); color: var(--primary); }

        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* LIST ITEMS */
        .list-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-bottom: 4px; border: 1px solid transparent; }
        .list-item:hover { background: var(--panel); border-color: var(--border); }
        .list-item.active { background: var(--primary-dim); border-color: rgba(16, 185, 129, 0.3); }
        
        .item-avatar { width: 36px; height: 36px; border-radius: 50%; background: #27272a; display: flex; align-items: center; justify-content: center; font-weight: bold; font-family: var(--font-mono); font-size: 14px; object-fit: cover; }
        
        .delete-btn { margin-left: auto; opacity: 0; transition: 0.2s; background: transparent; border: none; color: var(--text-dim); cursor: pointer; padding: 4px; }
        .list-item:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--danger); }

        /* MAIN CHAT */
        main { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        
        header { padding: 20px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(12, 12, 14, 0.95); backdrop-filter: blur(5px); }
        .header-title { font-family: var(--font-mono); font-size: 16px; font-weight: 700; color: var(--text); }
        .header-status { font-size: 12px; color: var(--success); display: flex; align-items: center; gap: 6px; }
        .header-status::before { content: ''; width: 8px; height: 8px; background: var(--success); border-radius: 50%; display: block; box-shadow: 0 0 10px var(--success); }

        #messages { flex: 1; overflow-y: auto; padding: 30px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg-group { display: flex; flex-direction: column; max-width: 60%; animation: fadeIn 0.2s ease; }
        .msg-group.sent { align-self: flex-end; align-items: flex-end; }
        .msg-group.received { align-self: flex-start; align-items: flex-start; }
        
        .msg-meta { font-family: var(--font-mono); font-size: 10px; color: var(--text-dim); margin-bottom: 5px; opacity: 0.8; }
        
        .msg-bubble { padding: 12px 18px; border-radius: 4px; font-size: 14px; line-height: 1.5; position: relative; word-wrap: break-word; }
        .sent .msg-bubble { background: var(--primary-dim); color: var(--primary); border: 1px solid rgba(16, 185, 129, 0.3); border-bottom-right-radius: 0; }
        .received .msg-bubble { background: var(--panel); color: var(--text); border: 1px solid var(--border); border-bottom-left-radius: 0; }
        
        .input-area { padding: 20px; background: var(--sidebar); border-top: 1px solid var(--border); display: flex; gap: 10px; }
        .chat-input { flex: 1; background: var(--bg); border: 1px solid var(--border); padding: 12px 16px; border-radius: 6px; color: white; font-family: var(--font-ui); transition: 0.2s; }
        .chat-input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-dim); }
        
        .icon-btn { background: var(--primary); color: #000; font-weight: bold; border: none; padding: 0 20px; border-radius: 6px; cursor: pointer; font-family: var(--font-mono); text-transform: uppercase; font-size: 12px; transition: 0.2s; }
        .icon-btn:hover { background: var(--primary-hover); }

        /* MODALS & AUTH */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal { width: 380px; background: #111; border: 1px solid var(--border); border-radius: 12px; padding: 30px; box-shadow: 0 20px 50px rgba(0,0,0,0.7); position: relative; }
        .modal-close { position: absolute; top: 15px; right: 15px; background: transparent; border: none; color: var(--text-dim); cursor: pointer; }

        .auth-input { width: 100%; padding: 12px; margin: 8px 0; background: #1a1a1d; border: 1px solid var(--border); color: white; border-radius: 6px; font-family: var(--font-mono); font-size: 13px; }
        .auth-input:focus { border-color: var(--primary); }
        .btn-full { width: 100%; padding: 14px; background: var(--primary); border: none; border-radius: 6px; color: #000; font-weight: 700; cursor: pointer; margin-top: 15px; font-family: var(--font-mono); text-transform: uppercase; letter-spacing: 1px; }

        /* PROFILE */
        .profile-lg-img { width: 80px; height: 80px; border-radius: 8px; border: 2px solid var(--primary); margin-bottom: 15px; object-fit: cover; }
        .profile-bio { background: var(--panel); padding: 12px; border-radius: 6px; font-size: 13px; color: var(--text-dim); border-left: 3px solid var(--primary); font-family: var(--font-mono); margin-top: 10px; }

        /* TOASTS */
        #toast-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 200; }
        .toast { background: var(--panel); border: 1px solid var(--border); padding: 12px 20px; border-radius: 4px; display: flex; align-items: center; gap: 10px; font-size: 13px; font-family: var(--font-mono); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="modal-overlay">
        <div class="modal" style="text-align: center;">
            <svg class="signal-icon" viewBox="0 0 24 24" style="margin: 0 auto 15px auto; width: 40px; height: 40px;">
                <path d="M2 22h20V2z"></path>
            </svg>
            <h1 style="font-family: var(--font-mono); font-size: 28px; margin: 0 0 5px 0; color:white;">UPLINK</h1>
            <p style="color: var(--text-dim); margin-bottom: 30px; font-size: 13px; font-family: var(--font-mono);">SECURE SIGNAL ESTABLISHED</p>
            <input id="auth-user" class="auth-input" placeholder="CODENAME">
            <input id="auth-pass" class="auth-input" type="password" placeholder="PASSWORD">
            <button class="btn-full" onclick="handleAuth('login')">CONNECT</button>
            <button class="btn-full" onclick="handleAuth('register')" style="background: transparent; border: 1px solid var(--border); color: white;">INITIALIZE NEW ID</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-ui" class="hidden" style="width: 100%; height: 100%; display: flex;">
        
        <aside>
            <div class="brand-section">
                <svg class="signal-icon" viewBox="0 0 24 24"><path d="M2 22h20V2z"></path></svg>
                <span class="brand-text">UPLINK</span>
            </div>

            <div class="profile-strip" onclick="openProfile(currentUser.id)">
                <img id="my-avatar" class="my-avatar" src="">
                <div style="flex:1">
                    <div id="my-name" style="font-weight: 700; font-size: 14px;"></div>
                    <div style="font-size: 10px; color: var(--success); font-family: var(--font-mono);">:: ONLINE ::</div>
                </div>
                <button style="background:transparent; border:none; color:var(--text-dim); cursor:pointer;" onclick="event.stopPropagation(); openSettings()">⚙</button>
            </div>

            <div class="nav-tabs">
                <div class="nav-item active" onclick="switchTab('chats', this)">Freqs</div>
                <div class="nav-item" onclick="switchTab('contacts', this)">Links</div>
                <div class="nav-item" onclick="switchTab('discover', this)">Scan</div>
                <div class="nav-item" onclick="switchTab('requests', this)">Inbound <span id="badge-req"></span></div>
            </div>

            <div id="list-chats" class="list-container"></div>
            <div id="list-contacts" class="list-container hidden"></div>
            <div id="list-discover" class="list-container hidden"></div>
            <div id="list-requests" class="list-container hidden"></div>
        </aside>

        <main>
            <header>
                <div class="header-title" id="chat-title">NO SIGNAL SELECTED</div>
                <div class="header-status" id="chat-status">AWAITING INPUT</div>
            </header>

            <div id="messages"></div>

            <div id="input-area" class="input-area hidden">
                <input id="msg-input" class="chat-input" placeholder="Transmit message..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button class="icon-btn" onclick="sendMessage()">SEND</button>
            </div>
        </main>
    </div>

    <!-- PROFILE MODAL -->
    <div id="profile-modal" class="modal-overlay hidden">
        <div class="modal" style="text-align: center;">
            <button class="modal-close" onclick="closeModal('profile-modal')">✕</button>
            <img id="p-img" class="profile-lg-img">
            <h2 id="p-name" style="margin: 0; font-family: var(--font-mono);"></h2>
            <div id="p-bio" class="profile-bio"></div>
            <div style="margin-top: 20px; font-size: 11px; color: var(--text-dim); font-family: var(--font-mono);">
                FIRST CONTACT: <span id="p-joined" style="color:var(--primary)"></span>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="modal-overlay hidden">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('settings-modal')">✕</button>
            <h2 style="font-family: var(--font-mono);">SETTINGS</h2>
            
            <label style="font-size:11px; color:var(--text-dim); font-family:var(--font-mono)">AVATAR SEED</label>
            <input id="edit-seed" class="auth-input">
            
            <label style="font-size:11px; color:var(--text-dim); font-family:var(--font-mono)">STATUS / BIO</label>
            <textarea id="edit-bio" class="auth-input" rows="3"></textarea>
            
            <button class="btn-full" onclick="saveProfile()">UPDATE SIGNAL</button>
            <button class="btn-full" style="background: transparent; border: 1px solid var(--danger); color: var(--danger); margin-top: 10px;" onclick="location.reload()">TERMINATE SESSION</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // ==========================================
        // CONFIG - PASTE WORKER URL HERE
        // ==========================================
        const API = 'https://chat-app.jcalv.workers.dev'; 
        // ==========================================

        let currentUser = null;
        let activeChatId = null;
        let pollInterval = null;

        // --- UTILS ---
        const $ = (id) => document.getElementById(id);
        function toast(msg, type='success') {
            const div = document.createElement('div');
            div.className = `toast ${type}`;
            div.innerHTML = `<span>${type === 'success' ? '✔' : '✖'}</span> ${msg}`;
            $('toast-container').appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }

        async function api(path, method='GET', body=null) {
            try {
                const opts = { method, headers: {'Content-Type':'application/json'} };
                if(body) opts.body = JSON.stringify(body);
                const res = await fetch(API + path, opts);
                return await res.json();
            } catch(e) {
                toast("Connection Failure", "error");
                return { error: "Network Error" };
            }
        }

        // --- AUTH ---
        async function handleAuth(type) {
            const u = $('auth-user').value;
            const p = $('auth-pass').value;
            if(!u || !p) return toast("Credentials missing", "error");

            const res = await api(`/api/${type}`, 'POST', {username: u, password: p});
            if(res.error) return toast(res.error, "error");

            currentUser = res.user;
            $('auth-screen').classList.add('hidden');
            $('app-ui').classList.remove('hidden');
            updateMyProfileUI();
            refreshLists();
        }

        function updateMyProfileUI() {
            $('my-name').innerText = currentUser.username;
            $('my-avatar').src = currentUser.avatar;
            $('edit-bio').value = currentUser.bio || "";
        }

        // --- NAVIGATION ---
        function switchTab(tabName, btn) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            btn.classList.add('active');
            ['chats', 'contacts', 'discover', 'requests'].forEach(t => $(`list-${t}`).classList.add('hidden'));
            $(`list-${tabName}`).classList.remove('hidden');
            refreshLists();
        }

        async function refreshLists() {
            const chats = await api(`/api/chats?userId=${currentUser.id}`);
            renderList('list-chats', chats, (item) => `
                <div class="list-item ${activeChatId === item.id ? 'active' : ''}" onclick="openChat('${item.id}', '${item.name}')">
                    <div class="item-avatar" style="color:var(--primary)">${item.name.substring(0,2).toUpperCase()}</div>
                    <div style="flex:1; overflow:hidden;">
                        <div style="font-weight:700; font-size:13px;">${item.name}</div>
                        <div style="font-size:11px; color:var(--text-dim); font-family:var(--font-mono)">ENCRYPTED CH 1</div>
                    </div>
                    <button class="delete-btn" onclick="deleteChat('${item.id}', event)">✕</button>
                </div>
            `);

            const contacts = await api(`/api/friends/list?userId=${currentUser.id}`);
            renderList('list-contacts', contacts, (u) => `
                <div class="list-item" onclick="openProfile('${u.id}')">
                    <img src="${u.avatar}" class="item-avatar">
                    <div style="flex:1; font-weight:600;">${u.username}</div>
                    <button class="icon-btn" style="padding:4px 8px; font-size:10px; width:auto;" onclick="event.stopPropagation(); restoreChat('${u.id}')">LINK</button>
                </div>
            `);

            const discover = await api(`/api/users/discover?userId=${currentUser.id}`);
            renderList('list-discover', discover, (u) => `
                <div class="list-item" onclick="openProfile('${u.id}')">
                    <img src="${u.avatar}" class="item-avatar">
                    <div style="flex:1; font-weight:600;">${u.username}</div>
                    <button class="icon-btn" style="padding:4px 8px; font-size:10px; width:auto;" onclick="event.stopPropagation(); addFriend('${u.id}', this)">PING</button>
                </div>
            `);

            const reqs = await api(`/api/friends/pending?userId=${currentUser.id}`);
            $('badge-req').innerText = reqs.length || "";
            renderList('list-requests', reqs, (r) => `
                <div class="list-item">
                    <img src="${r.avatar}" class="item-avatar">
                    <div style="flex:1;">${r.username}</div>
                    <button class="icon-btn" style="padding:4px 8px; font-size:10px; width:auto; background:var(--primary)" onclick="acceptFriend('${r.req_id}')">ACCEPT</button>
                </div>
            `);
        }

        function renderList(id, data, templateFn) {
            const container = $(id);
            container.innerHTML = '';
            if(!data || !data.length) container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--text-dim); font-family:var(--font-mono); font-size:11px;">NO SIGNAL DETECTED</div>`;
            else data.forEach(item => { container.innerHTML += templateFn(item); });
        }

       // --- CHAT LOGIC ---
        function openChat(id, name) {
            // 1. If we are already in this chat, do nothing (prevents reload loop)
            if (activeChatId === id) return;

            activeChatId = id;
            $('chat-title').innerText = name.toUpperCase();
            $('chat-status').innerText = "SECURE CHANNEL ACTIVE";
            $('input-area').classList.remove('hidden');
            
            // 2. Clear messages ONLY when switching chats
            $('messages').innerHTML = ''; 

            // 3. UI Updates
            document.querySelectorAll('.list-item').forEach(el => el.classList.remove('active'));
            refreshLists();
            
            // 4. Start Polling
            if(pollInterval) clearInterval(pollInterval);
            fetchMessages(); // Run immediately
            pollInterval = setInterval(fetchMessages, 2000); // Run every 2s
        }

        async function fetchMessages() {
            if(!activeChatId) return;
            
            // 1. Fetch data
            const msgs = await api(`/api/chats/${activeChatId}/messages`);
            const container = $('messages');
            
            // 2. Check scroll position BEFORE adding messages
            // (If user is scrolled up reading history, don't yank them down)
            const isAtBottom = (container.scrollHeight - container.scrollTop) <= (container.clientHeight + 100);
            
            msgs.forEach(m => {
                // 3. THE FIX: Check if message already exists in DOM
                // We use the unique Database ID (m.id) to track it
                if (document.getElementById(`msg-${m.id}`)) return; 

                // 4. Create Element (Append Only)
                const isMe = m.user_id === currentUser.id;
                const time = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                
                // Create HTML string
                const msgHTML = `
                    <div class="msg-group ${isMe ? 'sent' : 'received'}" id="msg-${m.id}">
                        <div class="msg-meta">${isMe ? 'YOU' : m.username.toUpperCase()} // ${time}</div>
                        <div class="msg-bubble">${safe(m.content)}</div>
                    </div>
                `;
                
                // Append to container
                container.insertAdjacentHTML('beforeend', msgHTML);
            });

            // 5. Scroll to bottom ONLY if we were already at bottom or it's a new load
            if(isAtBottom) {
                container.scrollTop = container.scrollHeight;
            }
        }
        async function fetchMessages() {
            if(!activeChatId) return;
            const msgs = await api(`/api/chats/${activeChatId}/messages`);
            const container = $('messages');
            const isAtBottom = (container.scrollHeight - container.scrollTop) <= (container.clientHeight + 150);
            
            container.innerHTML = '';
            msgs.forEach(m => {
                const isMe = m.user_id === currentUser.id;
                const time = new Date(m.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                container.innerHTML += `
                    <div class="msg-group ${isMe ? 'sent' : 'received'}">
                        <div class="msg-meta">${isMe ? 'YOU' : m.username.toUpperCase()} // ${time}</div>
                        <div class="msg-bubble">${safe(m.content)}</div>
                    </div>
                `;
            });
            if(isAtBottom) container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const txt = $('msg-input').value.trim();
            if(!txt) return;
            $('msg-input').value = '';
            await api('/api/message', 'POST', {chatId: activeChatId, userId: currentUser.id, username: currentUser.username, content: txt});
            fetchMessages();
        }

        async function deleteChat(chatId, e) {
            e.stopPropagation();
            if(!confirm("Terminate frequency?")) return;
            await api('/api/chats/delete', 'POST', {chatId, userId: currentUser.id});
            if(activeChatId === chatId) {
                activeChatId = null;
                $('messages').innerHTML = '';
                $('chat-title').innerText = "NO SIGNAL SELECTED";
                $('input-area').classList.add('hidden');
            }
            refreshLists();
            toast("Frequency Closed");
        }

        async function restoreChat(friendId) {
            const res = await api('/api/chats/restore', 'POST', {myId: currentUser.id, friendId});
            if(res.success) {
                const btn = document.querySelector('.nav-item'); // Switch to Freqs
                switchTab('chats', btn);
                setTimeout(() => openChat(res.chatId, "ESTABLISHING LINK..."), 500);
            }
        }

        // --- ACTIONS ---
        async function addFriend(id, btn) {
            const res = await api('/api/friends/request', 'POST', {myId: currentUser.id, targetId: id});
            if(res.success) { btn.innerText = "PINGED"; btn.disabled = true; toast("Signal Sent"); }
            else toast(res.error, "error");
        }

        async function acceptFriend(reqId) {
            await api('/api/friends/accept', 'POST', {reqId, myId: currentUser.id});
            toast("Link Established");
            refreshLists();
        }

        async function openProfile(userId) {
            const user = await api(`/api/users/get?id=${userId}`);
            $('p-img').src = user.avatar || currentUser.avatar;
            $('p-name').innerText = user.username.toUpperCase();
            $('p-bio').innerText = user.bio || "NO DATA";
            $('p-joined').innerText = new Date(user.created_at).toLocaleDateString();
            $('profile-modal').classList.remove('hidden');
        }

        function openSettings() { $('settings-modal').classList.remove('hidden'); }
        function closeModal(id) { $(id).classList.add('hidden'); }

        async function saveProfile() {
            const seed = $('edit-seed').value;
            const bio = $('edit-bio').value;
            if(seed) {
                const res = await api('/api/users/update', 'POST', {userId: currentUser.id, avatarSeed: seed});
                if(res.success) currentUser.avatar = res.avatar;
            }
            if(bio) {
                await api('/api/users/update', 'POST', {userId: currentUser.id, bio: bio});
                currentUser.bio = bio;
            }
            toast("Signal Updated");
            updateMyProfileUI();
            closeModal('settings-modal');
        }

        function safe(str) { return str.replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
    </script>
</body>
</html>

